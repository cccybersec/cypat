#!/bin/bash

# This script performs malware and virus scanning on an Ubuntu system for a CyberPatriot competition.

# Update package lists
function update_system() {
    if ! sudo apt-get update; then
        echo "Failed to update package lists"
        return 1
    fi
}

# Install clamscan
function install_clamscan() {
    if ! sudo apt-get install clamav; then
        echo "Failed to install ClamAV"
        return 1
    fi
}

# Install freshclam
function freshclam() {
    if ! freshclam; then
        echo "Failed to update virus definitions"
        return 1
    fi
}

# Install rkhunter
function install_rkhunter() {
    if ! sudo apt-get install rkhunter; then
        echo "Failed to install rkhunter"
        return 1
    fi
}

# Install lynis
function install_lynis() {
    if ! sudo apt-get install lynis; then
        echo "Failed to install lynis"
        return 1
    fi
}

# Check if the required tools are installed
function check_clamscan() {
    if ! command -v clamscan &>/dev/null; then
        echo "clamscan could not be found. Please install ClamAV."
        return 1
    fi
}
function check_rkhunter() {
    if ! command -v rkhunter &>/dev/null; then
        echo "rkhunter could not be found. Please install rkhunter."
        return 1
    fi
}
function check_lynis() {
    if ! command -v lynis &>/dev/null; then
        echo "lynis could not be found. Please install lynis."
        return 1
    fi
}

# Run malware scan using clamscan
function run_clamscan() {
    echo "Running malware scan using clamscan..."
    if ! clamscan -r / 2>/dev/null; then
        echo "Failed to run clamscan"
        return 1
    fi
}

# Run rootkit scan using rkhunter
function run_rkhunter() {
    echo "Running rootkit scan using rkhunter..."
    if ! rkhunter --check 2>/dev/null; then
        echo "Failed to run rkhunter"
        return 1
    fi
}

# Perform system-wide security scan with lynis
function run_lynis() {
    echo "Performing system-wide security scan with lynis..."
    if ! lynis audit system 2>/dev/null; then
        echo "Failed to run lynis"
        return 1
    fi
}

# Schedule and automate regular malware and rootkit scans
function schedule_scans() {
    echo "Scheduling and automating regular malware and rootkit scans..."
    (
        crontab -l 2>/dev/null
        echo "0 0 * * * clamscan -r / && rkhunter --check && lynis audit system"
    ) | crontab -
}

# Run all scans
function run_all_scans() {
    if ! run_clamscan; then
        return 1
    fi
    if ! run_rkhunter; then
        return 1
    fi
    if ! run_lynis; then
        return 1
    fi
    schedule_scans
    echo "Malware and virus scanning complete."
}

# Main function to run the script

update_system
install_clamscan
freshclam
install_rkhunter
install_lynis
check_clamscan
check_rkhunter
check_lynis
run_all_scans
